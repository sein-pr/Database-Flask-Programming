{% extends "base.html" %}

{% block title %}Appointments - SEIN Hospital Management{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1><i class="fas fa-calendar-alt"></i> Appointments</h1>
        <p>Manage patient appointments and schedules</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('add_appointment') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Schedule Appointment
        </a>
        <div class="view-toggle">
            <a href="{{ url_for('appointments', view='list') }}" 
               class="btn {% if view == 'list' %}btn-primary{% else %}btn-outline{% endif %}">
                <i class="fas fa-list"></i> List
            </a>
            <a href="{{ url_for('appointments', view='calendar') }}" 
               class="btn {% if view == 'calendar' %}btn-primary{% else %}btn-outline{% endif %}">
                <i class="fas fa-calendar"></i> Calendar
            </a>
        </div>
    </div>
</div>

{% if view == 'calendar' %}
<div class="modern-calendar-container">
    <div class="calendar-main">
        <div class="calendar-title">
            <h2>Appointments Calendar</h2>
        </div>
        
        <div class="year-navigation">
            <button id="prevYear" class="nav-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="currentYear">2025</span>
            <button id="nextYear" class="nav-btn">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="months-row">
            <div class="month-tab" data-month="0">JAN</div>
            <div class="month-tab" data-month="1">FEB</div>
            <div class="month-tab" data-month="2">MAR</div>
            <div class="month-tab" data-month="3">APR</div>
            <div class="month-tab" data-month="4">MAY</div>
            <div class="month-tab" data-month="5">JUN</div>
            <div class="month-tab" data-month="6">JUL</div>
            <div class="month-tab" data-month="7">AUG</div>
            <div class="month-tab" data-month="8">SEP</div>
            <div class="month-tab" data-month="9">OCT</div>
            <div class="month-tab" data-month="10">NOV</div>
            <div class="month-tab" data-month="11">DEC</div>
        </div>
        
        <div class="calendar-grid">
            <div class="weekdays-header">
                <div class="weekday-header">SUN</div>
                <div class="weekday-header">MON</div>
                <div class="weekday-header">TUE</div>
                <div class="weekday-header">WED</div>
                <div class="weekday-header">THU</div>
                <div class="weekday-header">FRI</div>
                <div class="weekday-header">SAT</div>
            </div>
            <div id="calendarGrid" class="calendar-days-grid">
                 Days will be populated by JavaScript 
            </div>
        </div>
        
        <div class="calendar-actions">
            <button id="addEventBtn" class="add-event-btn">
                <i class="fas fa-plus"></i> Add Appointment
            </button>
        </div>
    </div>
    
    <div class="event-details-sidebar">
        <div id="eventDetails" class="event-details-content">
            <div class="no-selection">
                <i class="fas fa-calendar-day"></i>
                <p>Select a date to view appointments</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="filters-section">
    <form method="GET" class="filters-form">
        <input type="hidden" name="view" value="list">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="date">Date</label>
                <input type="date" id="date" name="date" value="{{ date_filter }}" class="form-control">
            </div>
            <div class="filter-group">
                <label for="doctor">Doctor</label>
                <select id="doctor" name="doctor" class="form-control">
                    <option value="">All Doctors</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor.id }}" {% if doctor_filter == doctor.id|string %}selected{% endif %}>
                        Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="patient">Patient</label>
                <select id="patient" name="patient" class="form-control">
                    <option value="">All Patients</option>
                    {% for patient in patients %}
                    <option value="{{ patient.id }}" {% if patient_filter == patient.id|string %}selected{% endif %}>
                        {{ patient.first_name }} {{ patient.last_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control">
                    <option value="">All Statuses</option>
                    <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-secondary">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{{ url_for('appointments', view='list') }}" class="btn btn-outline">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </div>
    </form>
</div>

<div class="appointments-list">
    {% for appointment in appointments %}
    <div class="appointment-card">
        <div class="appointment-date-time">
            <div class="date">
                <i class="fas fa-calendar"></i>
                {{ appointment.appointment_date.strftime('%B %d, %Y') }}
            </div>
            <div class="time">
                <i class="fas fa-clock"></i>
                {{ appointment.appointment_time.strftime('%I:%M %p') }}
            </div>
        </div>
        
        <div class="appointment-details">
            <div class="patient-info">
                <h4>{{ appointment.patient_ref.first_name }} {{ appointment.patient_ref.last_name }}</h4>
                <p><i class="fas fa-user"></i> {{ appointment.patient_ref.age }} years old, {{ appointment.patient_ref.gender }}</p>
            </div>
            <div class="doctor-info">
                <h4>Dr. {{ appointment.doctor_ref.first_name }} {{ appointment.doctor_ref.last_name }}</h4>
                <p><i class="fas fa-stethoscope"></i> {{ appointment.doctor_ref.specialization_ref.name }}</p>
            </div>
        </div>
        
        <div class="appointment-status">
            <span class="status-badge status-{{ appointment.status }}">
                {{ appointment.status.title() }}
            </span>
        </div>
        
        <div class="appointment-actions">
            <a href="{{ url_for('appointment_detail', appointment_id=appointment.id) }}" 
               class="btn btn-sm btn-primary">
                <i class="fas fa-eye"></i> View
            </a>
            <a href="{{ url_for('edit_appointment', appointment_id=appointment.id) }}" 
               class="btn btn-sm btn-secondary">
                <i class="fas fa-edit"></i> Edit
            </a>
            <form method="POST" action="{{ url_for('delete_appointment', appointment_id=appointment.id) }}" 
                  style="display: inline;" 
                  onsubmit="return confirm('Are you sure you want to delete this appointment?')">
                <button type="submit" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-calendar-times"></i>
        <h3>No appointments found</h3>
        <p>{% if date_filter or doctor_filter or patient_filter or status_filter %}No appointments match your filter criteria.{% else %}Start by scheduling your first appointment.{% endif %}</p>
        {% if not date_filter and not doctor_filter and not patient_filter and not status_filter %}
        <a href="{{ url_for('add_appointment') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Schedule First Appointment
        </a>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if view == 'calendar' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    let selectedDate = null;
    let appointments = {};
    
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    const currentYearEl = document.getElementById('currentYear');
    const calendarGrid = document.getElementById('calendarGrid');
    const eventDetails = document.getElementById('eventDetails');
    const monthTabs = document.querySelectorAll('.month-tab');
    const addEventBtn = document.getElementById('addEventBtn');
    
    document.getElementById('prevYear').addEventListener('click', () => {
        currentDate.setFullYear(currentDate.getFullYear() - 1);
        updateCalendar();
    });
    
    document.getElementById('nextYear').addEventListener('click', () => {
        currentDate.setFullYear(currentDate.getFullYear() + 1);
        updateCalendar();
    });
    
    monthTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const month = parseInt(tab.dataset.month);
            currentDate.setMonth(month);
            updateCalendar();
        });
    });
    
    addEventBtn.addEventListener('click', () => {
        window.location.href = "{{ url_for('add_appointment') }}";
    });
    
    function updateCalendar() {
        currentYearEl.textContent = currentDate.getFullYear();
        
        // Update active month tab
        monthTabs.forEach(tab => tab.classList.remove('active'));
        monthTabs[currentDate.getMonth()].classList.add('active');
        
        loadAppointments();
    }
    
    function renderCalendarGrid() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        calendarGrid.innerHTML = '';
        
        for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day-cell';
            dayEl.textContent = date.getDate();
            
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            dayEl.dataset.date = dateStr;
            
            if (date.getMonth() !== month) {
                dayEl.classList.add('other-month');
            }
            
            if (date.toDateString() === new Date().toDateString()) {
                dayEl.classList.add('today');
            }
            
            if (appointments[dateStr] && appointments[dateStr].length > 0) {
                dayEl.classList.add('has-appointments');
                const indicator = document.createElement('div');
                indicator.className = 'appointment-indicator';
                dayEl.appendChild(indicator);
                console.log(`[v0] Day ${date.getDate()} (${dateStr}) has ${appointments[dateStr].length} appointments`);
            }
            
            dayEl.addEventListener('click', () => selectDate(dateStr, dayEl));
            
            calendarGrid.appendChild(dayEl);
        }
        
        console.log(`[v0] Rendered calendar grid. Total appointments object:`, appointments);
    }
    
    function selectDate(dateStr, dayEl) {
        document.querySelectorAll('.calendar-day-cell.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        dayEl.classList.add('selected');
        selectedDate = dateStr;
        
        console.log(`[v0] Selected date: ${dateStr}`);
        showEventDetails(dateStr);
    }
    
    function showEventDetails(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        
        console.log(`[v0] Showing details for: ${dateStr}, parsed as: ${date.toDateString()}`);
        
        const formattedDate = date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        const dayAppointments = appointments[dateStr] || [];
        console.log(`[v0] Found ${dayAppointments.length} appointments for ${dateStr}:`, dayAppointments);
        
        if (dayAppointments.length === 0) {
            eventDetails.innerHTML = `
                <div class="selected-date-header">
                    <h3>${formattedDate}</h3>
                </div>
                <div class="no-events">
                    <i class="fas fa-calendar-times"></i>
                    <p>There are no appointments planned for ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}.</p>
                </div>
            `;
        } else {
            let html = `
                <div class="selected-date-header">
                    <h3>${formattedDate}</h3>
                    <span class="appointment-count">${dayAppointments.length} appointment${dayAppointments.length > 1 ? 's' : ''}</span>
                </div>
                <div class="appointments-list">
            `;
            
            dayAppointments.forEach(appointment => {
                const time = new Date(appointment.start).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                const statusClass = appointment.backgroundColor === '#50a69e' ? 'scheduled' : 
                                   appointment.backgroundColor === '#27ae60' ? 'completed' : 'cancelled';
                
                html += `
                    <div class="appointment-item" style="color: white;">
                        <div class="appointment-time" style="color: white;" >${time}</div>
                        <div class="appointment-info">
                            <div class="appointment-title">${appointment.title}</div>
                            <div class="appointment-status status-${statusClass}">
                                ${statusClass.charAt(0).toUpperCase() + statusClass.slice(1)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            eventDetails.innerHTML = html;
        }
    }
    
    function loadAppointments() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const startDate = new Date(year, month, 1).toISOString().split('T')[0];
        const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
        
        console.log(`[v0] Loading appointments from ${startDate} to ${endDate}`);
        
        fetch(`/api/calendar-appointments?start=${startDate}&end=${endDate}`)
            .then(response => {
                console.log(`[v0] API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`[v0] Loaded ${data.length} appointments:`, data);
                appointments = {};
                
                data.forEach(appointment => {
                    const date = appointment.start.split('T')[0];
                    if (!appointments[date]) {
                        appointments[date] = [];
                    }
                    appointments[date].push(appointment);
                    console.log(`[v0] Added appointment for ${date}:`, appointment.title);
                });
                
                console.log(`[v0] Final processed appointments by date:`, appointments);
                console.log(`[v0] Appointments object keys:`, Object.keys(appointments));
                renderCalendarGrid();
            })
            .catch(error => {
                console.error('[v0] Error loading appointments:', error);
                eventDetails.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading appointments: ${error.message}</p>
                        <p>Please check the browser console for more details.</p>
                    </div>
                `;
                renderCalendarGrid();
            });
    }
    
    // Initialize calendar
    updateCalendar();
});
</script>
{% endif %}
{% endblock %}
